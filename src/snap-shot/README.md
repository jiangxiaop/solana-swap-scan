# ğŸš€ åŒºå—é“¾å¿«ç…§ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## ğŸ“– æ¦‚è¿°

æœ¬æ–‡æ¡£æ€»ç»“äº†åŸºäºåŒºå—é«˜åº¦çš„Solanaäº¤æ˜“å¿«ç…§ç³»ç»Ÿçš„è®¾è®¡æ€è·¯ã€ç®—æ³•å®ç°å’Œæ€§èƒ½ä¼˜åŒ–ç­–ç•¥ã€‚è¯¥ç³»ç»Ÿæ”¯æŒTokenå¿«ç…§å’ŒWalletäº¤æ˜“å¿«ç…§ï¼Œç»è¿‡æ·±åº¦ä¼˜åŒ–åæ€§èƒ½æå‡æ˜¾è‘—ã€‚

## ğŸ¯ ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒç»„ä»¶
- **Tokenå¿«ç…§** (`src/snap-shot/token/`) - ä»£å¸äº¤æ˜“æ•°æ®èšåˆ
- **Walletå¿«ç…§** (`src/snap-shot/wallet-trading/`) - é’±åŒ…äº¤æ˜“è¡Œä¸ºåˆ†æ  
- **åŒºå—å¤„ç†å™¨** (`src/snap-shot/index.ts`) - åŒºå—çª—å£ç®¡ç†å’Œåè°ƒ

### å¿«ç…§ç±»å‹
1. **TokenNormSnapShot** - ä»£å¸ä»·æ ¼ã€äº¤æ˜“é‡ã€æµåŠ¨æ€§ç»Ÿè®¡
2. **SnapShotForWalletTrading** - é’±åŒ…æŒä»“ã€ç›ˆäºã€æ¸…ä»“å†å²

## âš¡ æ ¸å¿ƒä¼˜åŒ–ç­–ç•¥

### 1. Walletå¿«ç…§ä¼˜åŒ– - 159xæ€§èƒ½æå‡

#### ğŸ” é—®é¢˜è¯†åˆ«
- **åŸå§‹ç“¶é¢ˆ**ï¼š99.7%æ—¶é—´èŠ±åœ¨æ•°æ®åº“æŸ¥è¯¢
- **æŸ¥è¯¢æ¨¡å¼**ï¼šæ¯ä¸ªæ–°é’±åŒ…å•ç‹¬æŸ¥è¯¢å†å²æ•°æ®  
- **æ€§èƒ½è¡¨ç°**ï¼š30-36äº¤æ˜“/ç§’ï¼Œå¹³å‡37ms/æ¬¡æŸ¥è¯¢

#### ğŸš€ è§£å†³æ–¹æ¡ˆ
1. **é¢„è¿ç®—èšåˆ**ï¼šå°†é‡å¤é’±åŒ…åˆå¹¶ï¼Œå‡å°‘é‡å¤å¤„ç†
2. **æ‰¹é‡æŸ¥è¯¢**ï¼š500ä¸ªé’±åŒ…ä¸€ç»„è¿›è¡Œæ‰¹é‡å†å²æ•°æ®æŸ¥è¯¢
3. **å¹¶è¡Œå¤„ç†**ï¼šå¤šç»„åŒæ—¶å¤„ç†ï¼Œå……åˆ†åˆ©ç”¨ç³»ç»Ÿèµ„æº

#### ğŸ“Š æ€§èƒ½æå‡ç»“æœ
- **å¤„ç†é€Ÿåº¦**ï¼š5,832äº¤æ˜“/ç§’ (159xæå‡)
- **æŸ¥è¯¢æ—¶é—´**ï¼šä»37ms/æ¬¡é™åˆ°2.6ms/æ¬¡
- **æ€»ä½“æ—¶é—´**ï¼šä»56ç§’é™åˆ°3.4ç§’ (94.8%æ—¶é—´å‡å°‘)

### 2. Tokenå¿«ç…§åˆ†æ - ä¿æŒåŸç‰ˆæœ¬

#### ğŸ” æµ‹è¯•ç»“æœ
| è§„æ¨¡ | äº¤æ˜“æ•°é‡ | åŸç‰ˆæœ¬ | ä¼˜åŒ–ç‰ˆæœ¬ | æ€§èƒ½æ¯” |
|------|----------|--------|-----------|---------|
| å°è§„æ¨¡ | 2,000 | 3ms | 5ms | **0.60x** |
| ä¸­ç­‰è§„æ¨¡ | 30,000 | 26ms | 58ms | **0.45x** |
| å¤§è§„æ¨¡ | 250,000 | 100ms | 319ms | **0.31x** |

#### ğŸ¯ ç»“è®ºï¼šä½¿ç”¨åŸç‰ˆæœ¬
**åŸå› **ï¼šTokenå¿«ç…§æ˜¯çº¯è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œæ— æ•°æ®åº“æŸ¥è¯¢ç“¶é¢ˆï¼ŒåŸç‰ˆæœ¬å·²ç»å¾ˆä¼˜åŒ–

## ğŸ›¡ï¸ æ•°æ®å®‰å…¨ä¸é”™è¯¯å¤„ç†

### 1. NaNå€¼é˜²æŠ¤
```typescript
// å®‰å…¨è®¡ç®— solPriceï¼Œé¿å… NaN
if (typeof tx.usdPrice === 'number' && typeof tx.quotePrice === 'number' && 
    !isNaN(tx.usdPrice) && !isNaN(tx.quotePrice) && 
    tx.quotePrice > 0 && tx.usdPrice > 0) {
    walletSnapshot.solPrice = tx.usdPrice / tx.quotePrice;
} else {
    // ä½¿ç”¨å®‰å…¨çš„é»˜è®¤å€¼
    walletSnapshot.solPrice = 100;
}
```

### 2. æ—¶é—´æˆ³å¤„ç†
```typescript
// æ™ºèƒ½è¯†åˆ«Unixæ—¶é—´æˆ³ï¼ˆç§’/æ¯«ç§’ï¼‰
const timestampNum = parseInt(timestampStr);
if (!isNaN(timestampNum)) {
    let date;
    if (timestampNum > 1e12) {
        date = new Date(timestampNum);        // æ¯«ç§’æ—¶é—´æˆ³
    } else {
        date = new Date(timestampNum * 1000); // ç§’æ—¶é—´æˆ³
    }
    return date.toISOString().slice(0, 19).replace('T', ' ');
}
```

### 3. æ‰¹é‡æ•°æ®éªŒè¯
æ’å…¥å‰éªŒè¯æ‰€æœ‰æ•°å­—å­—æ®µçš„æœ‰æ•ˆæ€§ï¼Œé˜²æ­¢æ— æ•ˆæ•°æ®è¿›å…¥æ•°æ®åº“

## ğŸ“ˆ ç®—æ³•é€‰æ‹©åŸåˆ™

```
æ˜¯å¦æœ‰æ•°æ®åº“æŸ¥è¯¢ç“¶é¢ˆï¼Ÿ
â”œâ”€â”€ æ˜¯ â†’ ä½¿ç”¨ä¼˜åŒ–ç‰ˆæœ¬ï¼ˆé¢„è¿ç®—+æ‰¹é‡æŸ¥è¯¢+å¹¶è¡Œå¤„ç†ï¼‰
â””â”€â”€ å¦ â†’ ä¿æŒåŸç‰ˆæœ¬ï¼ˆé¿å…ä¸å¿…è¦çš„å¤æ‚æ€§ï¼‰
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥

1. **æ€§èƒ½å¯¹æ¯”æµ‹è¯•** - åŸç‰ˆæœ¬ vs ä¼˜åŒ–ç‰ˆæœ¬
2. **æ•°æ®ä¸€è‡´æ€§éªŒè¯** - ç¡®ä¿ä¼˜åŒ–ä¸å½±å“å‡†ç¡®æ€§  
3. **å¤§è§„æ¨¡å‹åŠ›æµ‹è¯•** - éªŒè¯ç³»ç»Ÿç¨³å®šæ€§

## ğŸ¯ æœ€ä½³å®è·µ

1. **ğŸ” ç²¾å‡†è¯†åˆ«ç“¶é¢ˆ**ï¼šä½¿ç”¨è¯¦ç»†çš„æ€§èƒ½ç›‘æ§å®šä½çœŸæ­£çš„ç“¶é¢ˆ
2. **ğŸ“Š æ•°æ®é©±åŠ¨å†³ç­–**ï¼šåŸºäºå®é™…æµ‹è¯•æ•°æ®è€Œéå‡è®¾è¿›è¡Œä¼˜åŒ–
3. **âš–ï¸ æƒè¡¡å¤æ‚æ€§**ï¼šç¡®ä¿ä¼˜åŒ–æ”¶ç›Šå¤§äºå¼•å…¥çš„å¤æ‚æ€§æˆæœ¬
4. **ğŸ§ª å……åˆ†æµ‹è¯•éªŒè¯**ï¼šä»»ä½•ä¼˜åŒ–éƒ½å¿…é¡»ä¿è¯åŠŸèƒ½æ­£ç¡®æ€§

## ğŸ”§ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### Q1: NaNå€¼å¯¼è‡´æ•°æ®åº“é”™è¯¯
**ç—‡çŠ¶**ï¼š`Error: Unknown column 'NaN' in 'field list'`  
**è§£å†³æ–¹æ¡ˆ**ï¼šåœ¨è®¡ç®—å‰éªŒè¯è¾“å…¥å€¼ï¼Œä½¿ç”¨å®‰å…¨çš„é»˜è®¤å€¼

### Q2: æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ç“¶é¢ˆ  
**è§£å†³æ–¹æ¡ˆ**ï¼šæ‰¹é‡æŸ¥è¯¢ + é€‚å½“ç´¢å¼• + å¹¶è¡Œå¤„ç†

### Q3: è¿‡åº¦ä¼˜åŒ–é€‚å¾—å…¶å
**è§£å†³æ–¹æ¡ˆ**ï¼šåˆ†æä»»åŠ¡ç‰¹æ€§ï¼Œæµ‹è¯•ä¸åŒè§„æ¨¡ä¸‹çš„æ€§èƒ½è¡¨ç°

## ğŸ“Š å®é™…æ€§èƒ½æ•°æ®

### æœ€ç»ˆç³»ç»Ÿè¡¨ç°
- **æ€»å¤„ç†æ—¶é—´**ï¼š6.6ç§’ï¼ˆå¤„ç†6ä¸ªåŒºå—çª—å£ï¼‰
- **å¿«ç…§ç”Ÿæˆæ•ˆç‡**ï¼š725å¿«ç…§/ç§’
- **æ•°æ®å®Œæ•´æ€§**ï¼š4117ä¸ªwalletå¿«ç…§ + 673ä¸ªtokenå¿«ç…§ï¼Œ100%æˆåŠŸä¿å­˜

## ğŸ“ æ ¸å¿ƒæ•™è®­

> ğŸ’¡ **æœ€é‡è¦çš„å‘ç°**ï¼šä¸æ˜¯æ‰€æœ‰çš„ä¼˜åŒ–éƒ½ä¼šå¸¦æ¥æ€§èƒ½æå‡ã€‚ç²¾å‡†è¯†åˆ«ç“¶é¢ˆï¼Œå› åœ°åˆ¶å®œåœ°é€‰æ‹©ä¼˜åŒ–ç­–ç•¥ï¼Œæ‰èƒ½è¾¾åˆ°æœ€ä½³æ•ˆæœï¼

## ğŸ“š å¼€å‘å‚è€ƒ

### å‡½æ•°ä½¿ç”¨æŒ‡å—
```typescript
// Walletå¿«ç…§ - ä½¿ç”¨ä¼˜åŒ–ç‰ˆæœ¬
import { snapshotWalletTradingByTxDataOptimized } from "./wallet-trading/index.ts";
const walletSnapshots = await snapshotWalletTradingByTxDataOptimized(transactions);

// Tokenå¿«ç…§ - ä½¿ç”¨åŸç‰ˆæœ¬
import { snapshotTokenValueByTxData } from "./token/index.ts";
const tokenSnapshots = snapshotTokenValueByTxData(transactions);

// åŒºå—é«˜åº¦å¿«ç…§
import { SnapshotForTokenAndWalletTrading } from "./index.ts";
const result = await SnapshotForTokenAndWalletTrading(startBlock, endBlock);
```

### æ•°æ®åº“ç´¢å¼•å»ºè®®
```sql
-- é’ˆå¯¹é’±åŒ…å¿«ç…§æŸ¥è¯¢ä¼˜åŒ–
CREATE INDEX idx_wallet_snapshot_time_desc 
ON wallet_trading_ss (wallet_address, snapshot_time DESC, id DESC);
```

---

**å¼€å‘å›¢é˜Ÿå»ºè®®**ï¼šåœ¨å¼€å‘æ–°çš„å¿«ç…§åŠŸèƒ½æ—¶ï¼Œå…ˆåˆ†ææ•°æ®æµç‰¹ç‚¹ï¼Œè¯†åˆ«çœŸæ­£çš„ç“¶é¢ˆï¼Œç„¶åé€‰æ‹©åˆé€‚çš„ä¼˜åŒ–ç­–ç•¥ã€‚è®°ä½ï¼Œç®€å•æœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆå¾€å¾€æ›´å¯é ï¼ 